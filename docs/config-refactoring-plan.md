# Config.yaml Refactoring Plan

## Overview
This document outlines the changes needed to align the Terraform code with the new config.yaml structure.

## Current State Analysis

### Config.yaml Structure Changes

#### Hub Section
```yaml
hub:
  alias: "gen3-csoc"
  aws_profile: "boadeyem_tf"
  aws_region: "us-east-1"
  
  vpc: { ... }
  eks: { ... }
  gitops: { ... }
  iam_gitops: { ... }
  
  addon_configs:      # NEW: Structured addon configuration
    ebs_csi:
      enable_pod_identity: false
      kms_arns: [...]
      namespace: "kube-system"
      service_account: "ebs-csi-controller-sa"
    external_secrets: { ... }
    aws_load_balancer_controller: { ... }
    # ... etc
    
  ack_configs:        # NEW: Structured ACK configuration
    cloudtrail:
      enable_pod_identity: true
      namespace: "ack-system"
      service_account: "ack-cloudtrail-controller"
    # ... etc
```

#### Spokes Section
```yaml
spokes:
  - alias: "spoke1"
    enabled: true
    region: "us-east-1"
    profile: "boadeyem_tf"
    gitops: { ... }
    
    ack_configs:      # NEW: Per-spoke ACK configuration
      cloudtrail:
        enable_pod_identity: true
      # ... etc
```

### Addons to Remove
Addons NOT in config.yaml addon_configs that should be removed from Terraform:
1. ✅ aws_appmesh_controller
2. ✅ aws_appmesh_envoy_proxy
3. ✅ aws_cloudwatch_observability
4. ✅ aws_fsx_lustre_csi
5. ✅ aws_gateway_controller
6. ✅ aws_lb_controller_targetgroup_binding_only
7. ✅ aws_node_termination_handler
8. ✅ aws_privateca_issuer
9. ✅ aws_vpc_cni_ipv4
10. ✅ aws_vpc_cni_ipv6
11. ✅ mountpoint_s3_csi
12. ✅ velero
13. ✅ amazon_managed_service_prometheus

### Addons to Keep
From config.yaml addon_configs:
1. ✅ ebs_csi
2. ✅ external_secrets
3. ✅ aws_load_balancer_controller
4. ✅ argocd
5. ✅ cert_manager
6. ✅ cluster_autoscaler
7. ✅ external_dns
8. ✅ aws_efs_csi

### ACK Controllers from Config
All 15 controllers listed in ack_configs:
- cloudtrail, cloudwatchlogs, ec2, efs, eks, iam, kms, opensearchservice, rds, route53, s3, secretsmanager, sns, sqs, wafv2

## Variables Not in Config.yaml (Computed or Default)

### Computed Variables (Generated by Modules - OK)
- `vpc_id` - from VPC module
- `subnet_ids` - from VPC module
- `cluster_endpoint` - from EKS module
- `oidc_provider_arn` - from EKS module
- `role_arn` (for each ACK/addon) - from pod-identity modules
- `policy_arn` - from policy modules

### Variables Currently Defined but NOT in config.yaml (Need to add OR compute)
From terragrunt.hcl current code:
1. ❌ `enable_multi_acct` - Should derive from: `length(spokes) > 0`
2. ❌ `enable_ack` - Should derive from: `length(ack_configs) > 0`
3. ❌ `vpc_tags`, `public_subnet_tags`, `private_subnet_tags` - Could be in vpc section or use defaults
4. ❌ `eks_cluster_tags` - Could be in eks section or use defaults
5. ❌ `cluster_compute_config` - IS in config.yaml under hub.eks
6. ❌ `existing_vpc_id`, `existing_subnet_ids` - IS in config.yaml under hub.vpc

### Variables to be Derived
```hcl
enable_multi_acct = length(local.spokes) > 0
enable_ack = length(local.hub_ack_configs) > 0
enable_ack_spoke_roles = local.enable_multi_acct && local.enable_ack
```

## Implementation Plan

### 1. Terragrunt.hcl Changes

#### Parse addon_configs
```hcl
# Flatten addon_configs from nested structure
addon_configs = lookup(local.hub_config, "addon_configs", {})

# Transform to enable flags
enable_ebs_csi = lookup(lookup(local.addon_configs, "ebs_csi", {}), "enable_pod_identity", false)
ebs_csi_config = lookup(local.addon_configs, "ebs_csi", {})
```

#### Parse ack_configs
```hcl
# Hub ACK configs
hub_ack_configs = lookup(local.hub_config, "ack_configs", {})

# Spoke ACK configs per spoke
spokes_with_ack = [
  for spoke in local.spokes : merge(spoke, {
    ack_configs = lookup(spoke, "ack_configs", {})
  })
]
```

#### Spoke ARN Inputs
```hcl
# Try to load spoke ARN files if they exist
spoke_arns_by_controller = {
  for spoke in local.spokes : spoke.alias => {
    for controller_name in keys(local.hub_ack_configs) : controller_name => 
      try(
        jsondecode(file("${get_repo_root()}/iam/gen3-kro/${spoke.alias}/ack-spoke-arns-${controller_name}.json")),
        {}
      )
  }
}
```

### 2. Hub variables.tf Changes

Replace individual addon variables with:
```hcl
variable "addon_configs" {
  description = "Map of addon configurations from config.yaml"
  type        = map(any)
  default     = {}
}

variable "ack_configs" {
  description = "Map of ACK controller configurations from config.yaml"
  type        = map(any)
  default     = {}
}

variable "spoke_arn_inputs" {
  description = "Map of spoke ARNs by spoke alias and controller"
  type        = map(map(any))
  default     = {}
}
```

### 3. Hub main.tf Changes

#### Update module calls with proper tag merging:
```hcl
module "vpc" {
  source = "../../modules/vpc"
  
  tags = merge(
    var.tags,
    var.vpc_tags,
    { caller_level = "vpc" }
  )
}

module "eks_cluster" {
  tags = merge(
    var.tags,
    var.eks_cluster_tags,
    { caller_level = "eks_cluster" }
  )
}
```

#### Update addons module to accept addon_configs:
```hcl
module "addons" {
  source = "../../modules/addons-pod-identities"
  
  addon_configs = var.addon_configs
  
  tags = merge(
    var.tags,
    { caller_level = "addons_pod_identities" }
  )
}
```

#### Update ACK modules to loop through ack_configs:
```hcl
module "ack" {
  source = "../../modules/ack-enhanced-pod-identity"
  
  for_each = var.ack_configs
  
  create = var.enable_vpc && var.enable_eks_cluster && lookup(each.value, "enable_pod_identity", true)
  
  cluster_name = var.cluster_name
  service_name = each.key
  
  association_defaults = {
    namespace = lookup(each.value, "namespace", "ack-system")
  }
  
  associations = {
    default = {
      cluster_name    = var.cluster_name
      service_account = lookup(each.value, "service_account", "ack-${each.key}-controller")
    }
  }
  
  tags = merge(
    var.tags,
    { 
      caller_level = "ack_${each.key}",
      ack_service = each.key
    }
  )
}
```

#### Update cross_account_policy to get spoke ARNs:
```hcl
module "cross_account_policy" {
  source = "../../modules/cross-account-policy"
  
  for_each = var.ack_configs
  
  create = local.enable_multi_acct && lookup(each.value, "enable_pod_identity", true)
  
  service_name              = each.key
  hub_pod_identity_role_arn = try(module.ack[each.key].role_arn, "")
  
  # Get spoke role ARNs from spoke module outputs OR spoke_arn_inputs
  spoke_role_arns = coalescelist(
    [for spoke in local.spokes : try(module.spoke_${spoke.alias}.ack_role_arns[each.key], "")],
    try(values(var.spoke_arn_inputs)[*][each.key].role_arn, [])
  )
  
  tags = merge(
    var.tags,
    { caller_level = "cross_account_policy_${each.key}" }
  )
}
```

### 4. Spoke-IAM Changes

Update to accept ack_configs:
```hcl
variable "ack_configs" {
  description = "Map of ACK controller configurations for this spoke"
  type        = map(any)
  default     = {}
}
```

Update spoke module calls in terragrunt:
```hcl
module "spoke_${spoke.alias}" {
  source = "combinations/spoke-iam"
  
  cluster_name = local.cluster_name
  ack_configs  = spoke.ack_configs
  
  tags = merge(
    local.base_tags,
    lookup(spoke, "tags", {}),
    { caller_level = "spoke_${spoke.alias}" }
  )
}
```

### 5. ACK Module Policy File Sourcing

Update ack-enhanced-pod-identity module to look for policy files with fallback:
```hcl
locals {
  # Determine context (hub or spoke)
  context = lookup(var.tags, "Spoke", null) != null ? var.tags["Spoke"] : "hub"
  
  # Try spoke-specific path first, then fall back to hub
  ack_permissions_path = local.context != "hub" ? 
    "${path.root}/../../iam/gen3-kro/${local.context}/acks/${var.service_name}" :
    "${path.root}/../../iam/gen3-kro/hub/acks/${var.service_name}"
  
  # Check if spoke-specific files exist, otherwise use hub
  has_spoke_inline = local.context != "hub" ? 
    fileexists("${path.root}/../../iam/gen3-kro/${local.context}/acks/${var.service_name}/source-policy-inline.json") : false
  
  has_hub_inline = fileexists("${path.root}/../../iam/gen3-kro/hub/acks/${var.service_name}/source-policy-inline.json")
  
  # Use spoke if exists, otherwise hub
  policy_path = local.has_spoke_inline ? 
    "${path.root}/../../iam/gen3-kro/${local.context}/acks/${var.service_name}" :
    "${path.root}/../../iam/gen3-kro/hub/acks/${var.service_name}"
  
  # Load policy files
  source_policy_inline = fileexists("${local.policy_path}/source-policy-inline.json") ? 
    file("${local.policy_path}/source-policy-inline.json") : null
  
  source_policy_arn = fileexists("${local.policy_path}/source-policy-arn.json") ? 
    jsondecode(file("${local.policy_path}/source-policy-arn.json")) : {}
  
  override_policy = fileexists("${local.policy_path}/overridepolicy.json") ? 
    file("${local.policy_path}/overridepolicy.json") : null
}
```

### 6. IAM Folder Structure

Expected structure:
```
iam/
  gen3-kro/
    hub/
      acks/
        cloudtrail/
          source-policy-inline.json
          source-policy-arn.json
          overridepolicy.json
        iam/
          source-policy-inline.json
          ...
      argocd/
        source-policy-inline.json
        ...
    spoke1/
      acks/
        iam/
          source-policy-inline.json  # Spoke-specific override
          overridepolicy.json
        # Other controllers use hub defaults
    spoke2/
      acks/
        # All controllers use hub defaults
```

## Tag Merging Strategy

All module calls should follow this pattern:
```hcl
tags = merge(
  var.tags,                    # Base tags from config.yaml
  var.<module>_tags,           # Module-specific tags
  {
    caller_level = "<module_name>"  # Identifies the module
  }
)
```

Example:
```hcl
tags = merge(
  var.tags,
  { caller_level = "vpc" }
)

tags = merge(
  var.tags,
  { 
    caller_level = "ack_iam",
    ack_service = "iam"
  }
)
```

## Validation Checklist

- [ ] All config.yaml variables flow to modules
- [ ] Per-controller enable_pod_identity works for hub
- [ ] Per-controller enable_pod_identity works for spokes
- [ ] Spoke ARNs can be passed via module outputs
- [ ] Spoke ARNs can be passed via JSON files
- [ ] Policy files source from iam/{hub|spoke} with fallback
- [ ] Unnecessary addons removed
- [ ] Tag merging implemented with caller_level
- [ ] Variables ack_cross_account_policies and cross_account_policy_tags NOT required from config
- [ ] Computed variables (enable_multi_acct, enable_ack) derived correctly

## Files to Modify

1. `/workspaces/gen3-kro/live/aws/us-east-1/gen3-kro-hub/terragrunt.hcl`
2. `/workspaces/gen3-kro/terraform/combinations/hub/variables.tf`
3. `/workspaces/gen3-kro/terraform/combinations/hub/main.tf`
4. `/workspaces/gen3-kro/terraform/combinations/hub/locals.tf`
5. `/workspaces/gen3-kro/terraform/combinations/spoke-iam/variables.tf`
6. `/workspaces/gen3-kro/terraform/combinations/spoke-iam/main.tf`
7. `/workspaces/gen3-kro/terraform/modules/addons-pod-identities/variables.tf`
8. `/workspaces/gen3-kro/terraform/modules/addons-pod-identities/main.tf`
9. `/workspaces/gen3-kro/terraform/modules/ack-enhanced-pod-identity/main.tf`
10. `/workspaces/gen3-kro/terraform/modules/cross-account-policy/main.tf`
