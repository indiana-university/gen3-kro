# Hub Addons ApplicationSet
#
# This ApplicationSet deploys cluster addons (KRO, ACK controllers, and platform components)
# to hub/control-plane clusters only.
#
# 1. Addon Catalog (addons/csoc/catalog.yaml)
#    - Defines available addons with their Helm chart sources and versions
#    - Centralized registry for KRO, ACK controllers, and platform components
#
# 2. Enablement Configuration: addons/csoc/enablement.yaml
#    - Controls which addons are deployed to hub clusters
#
# 3. Values Configuration: addons/csoc/values.yaml
#    - Provides addon-specific configuration (resource limits, IRSA roles, etc.)
#
# The ApplicationSet uses:
# - Matrix generator: Combines hub clusters with the addon catalog
# - Cluster annotations: hub_repo_url, hub_repo_revision, hub_repo_basepath
# - Cluster labels: fleet_member=control-plane (filters for hub only)
# - Multiple sources: Helm chart + values repository reference
#
# Sync waves:
# - Wave -1: KRO (must be installed first for ResourceGraphDefinitions)
# - Wave 0: All other addons
#
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: csoc-addons
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          # Hub clusters only (control-plane)
          - clusters:
              selector:
                matchLabels:
                  fleet_member: control-plane
          # Addon catalog from git repository
          - git:
              repoURL: '{{.metadata.annotations.hub_repo_url}}'
              revision: '{{.metadata.annotations.hub_repo_revision}}'
              files:
                - path: '{{.metadata.annotations.hub_repo_basepath}}/addons/csoc/catalog.yaml'
  template:
    metadata:
      name: '{{.name}}-{{.addon}}'
      labels:
        app.kubernetes.io/part-of: addons
        app.kubernetes.io/name: '{{.addon}}'
        cluster: '{{.name}}'
        addon: '{{.addon}}'
        fleet-member: control-plane
      annotations:
        # KRO must be installed first (wave -1), cloud controllers at wave 0
        argocd.argoproj.io/sync-wave: '{{if eq .addon "kro"}}"-1"{{else if or (hasPrefix "ack-" .addon) (hasPrefix "gcc-" .addon) (hasPrefix "aso-" .addon)}}"0"{{else}}"0"{{end}}'
    spec:
      project: default
      sources:
        # Addon Helm chart source
        - repoURL: '{{.repoURL}}'
          targetRevision: '{{.revision}}'
          chart: '{{.chart}}'
          helm:
            valueFiles:
              # Load values from hub location
              - $values/{{.metadata.annotations.hub_repo_basepath}}/addons/csoc/values.yaml
            # Addon-specific inline values
            values: |
              {{- if eq .addon "kro" }}
              # KRO-specific configuration
              image:
                tag: {{.revision}}
              {{- end }}
              {{- if hasPrefix "ack-" .addon }}
              # ACK controller common configuration
              aws:
                region: {{.metadata.annotations.aws_region}}
              {{- /* build a few possible annotation keys to be tolerant of different cluster secret naming */}}
              {{- $ann := .metadata.annotations }}
              {{- $addon := .addon }}
              {{- $noDash := replace $addon "-" "" }}
              {{- $trim := trimPrefix "ack-" $addon }}
              {{- $saKey1 := printf "ack_%s_service_account" $trim }}
              {{- $saKey2 := printf "%s_service_account" $noDash }}
              {{- $roleKey1 := printf "ack_%s_hub_role_arn" $trim }}
              {{- $roleKey2 := printf "%s_hub_role_arn" $noDash }}
              {{- $roleKey3 := printf "%s_irsa_role_arn" $noDash }}
              serviceAccount:
                name: {{- if hasKey $ann $saKey1 -}}{{ index $ann $saKey1 -}}{{- else if hasKey $ann $saKey2 -}}{{ index $ann $saKey2 -}}{{- else -}}{{- /* fall back to empty -*/ }}{{- end }}
                annotations:
                  eks.amazonaws.com/role-arn: {{- if hasKey $ann $roleKey1 -}}{{ index $ann $roleKey1 -}}{{- else if hasKey $ann $roleKey2 -}}{{ index $ann $roleKey2 -}}{{- else if hasKey $ann $roleKey3 -}}{{ index $ann $roleKey3 -}}{{- else -}}{{- /* leave blank if not present */ }}{{- end }}
              {{- end }}
        # Values repository reference for valueFiles
        - repoURL: '{{.metadata.annotations.hub_repo_url}}'
          targetRevision: '{{.metadata.annotations.hub_repo_revision}}'
          ref: values
      destination:
        name: '{{.name}}'
        # Namespace mapping: kro -> kro-system, ack-* -> ack-system, others use addon name
        namespace: '{{if eq .addon "kro"}}kro-system{{else if hasPrefix "ack-" .addon}}ack-system{{else}}{{.addon}}-system{{end}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
      # Ignore differences in CRD conversion webhooks (common with large CRDs)
      ignoreDifferences:
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
            - /status
