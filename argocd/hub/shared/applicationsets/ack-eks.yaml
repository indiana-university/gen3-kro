apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: ack-eks
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  syncPolicy:
    preserveResourcesOnDeletion: false
  generators:
  - clusters:
      selector:
        matchLabels:
          argocd.argoproj.io/secret-type: cluster
        matchExpressions:
          - key: enable_ack_eks
            operator: In
            values: ['true']
      values:
        # Allow deployment even if some clusters don't exist yet
        clusterAvailable: 'true'
  template:
    metadata:
      name: '{{.name}}-ack-eks'
      labels:
        app: ack-eks
        cluster: '{{.name}}'
      annotations:
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: default
      source:
        repoURL: public.ecr.aws
        chart: aws-controllers-k8s/eks-chart
        targetRevision: v1.6.0
        helm:
          releaseName: ack-eks-controller
          values: |
            aws:
              region: {{if eq .metadata.labels.fleet_member "control-plane"}}{{.metadata.annotations.hub_aws_region}}{{else}}{{.metadata.annotations.aws_region}}{{end}}
            serviceAccount:
              name: ack-eks-controller
              annotations:
                eks.amazonaws.com/role-arn: {{if eq .metadata.labels.fleet_member "control-plane"}}{{index .metadata.annotations "gen3-csoc-eks-ack-arn"}}{{else}}{{index .metadata.annotations (printf "%s-eks-ack-arn" .name)}}{{end}}
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 100m
                memory: 128Mi
      destination:
        server: '{{.server}}'
        namespace: ack-system
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
        retry:
          limit: -1
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 10m
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
