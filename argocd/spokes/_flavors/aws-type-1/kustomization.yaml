apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../csoc/_kustomize_flavors/aws-type-1

configMapGenerator:
  - name: spoke-values
    behavior: merge
    envs: [values.env]
    # merge behavior at level-2 allows example to override base values

replacements:
  # Sync Wave Annotations
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_namespace}
    targets: [{select: {kind: Namespace}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_vpc}
    targets: [{select: {kind: Vpc}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_eks}
    targets: [{select: {kind: EKS}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_rds}
    targets: [{select: {kind: RDS}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_elasticache}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_opensearch}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_data_bucket}
    targets: [{select: {kind: DataBucket}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_kms}
    targets: [{select: {kind: KMS}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.sync_wave_efs}
    targets: [{select: {kind: EFS}, fieldPaths: [metadata.annotations.argocd\.argoproj\.io/sync-wave]}]

  # Common Fields
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.namespace_name}
    targets:
      - {select: {kind: Namespace}, fieldPaths: [metadata.name]}
      - {select: {kind: Vpc}, fieldPaths: [metadata.namespace]}
      - {select: {kind: EKS}, fieldPaths: [metadata.namespace]}
      - {select: {kind: RDS}, fieldPaths: [metadata.namespace]}
      - {select: {kind: ElastiCache}, fieldPaths: [metadata.namespace]}
      - {select: {kind: OpenSearch}, fieldPaths: [metadata.namespace]}
      - {select: {kind: DataBucket}, fieldPaths: [metadata.namespace]}
      - {select: {kind: KMS}, fieldPaths: [metadata.namespace]}
      - {select: {kind: EFS}, fieldPaths: [metadata.namespace]}
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.region}
    targets:
      - {select: {kind: Vpc}, fieldPaths: [spec.region]}
      - {select: {kind: EKS}, fieldPaths: [spec.region]}
      - {select: {kind: RDS}, fieldPaths: [spec.region]}
      - {select: {kind: ElastiCache}, fieldPaths: [spec.region]}
      - {select: {kind: OpenSearch}, fieldPaths: [spec.region]}
      - {select: {kind: DataBucket}, fieldPaths: [spec.region]}
      - {select: {kind: KMS}, fieldPaths: [spec.region]}
      - {select: {kind: EFS}, fieldPaths: [spec.region]}

  # VPC
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_metadata_name}
    targets: [{select: {kind: Vpc}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_name}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_cidr}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.cidr.vpcCidr]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_public_subnet1_cidr}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.cidr.publicSubnet1Cidr]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_public_subnet2_cidr}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.cidr.publicSubnet2Cidr]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_private_subnet1_cidr}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.cidr.privateSubnet1Cidr]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.vpc_private_subnet2_cidr}
    targets: [{select: {kind: Vpc}, fieldPaths: [spec.cidr.privateSubnet2Cidr]}]

  # EKS
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_metadata_name}
    targets: [{select: {kind: EKS}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_name}
    targets: [{select: {kind: EKS}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_version}
    targets: [{select: {kind: EKS}, fieldPaths: [spec.version]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_node_instance_types}
    targets: [{select: {kind: EKS}, fieldPaths: ['spec.nodeGroupInstanceTypes[0]'], options: {create: true}}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_node_desired_size}
    targets: [{select: {kind: EKS}, fieldPaths: [spec.nodeGroupDesiredSize]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_node_min_size}
    targets: [{select: {kind: EKS}, fieldPaths: [spec.nodeGroupMinSize]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.eks_node_max_size}
    targets: [{select: {kind: EKS}, fieldPaths: [spec.nodeGroupMaxSize]}]

  # RDS
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_metadata_name}
    targets: [{select: {kind: RDS}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_name}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_engine}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.engine]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_engine_version}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.engineVersion]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_instance_class}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.instanceClass]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_allocated_storage}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.allocatedStorage]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.rds_database_name}
    targets: [{select: {kind: RDS}, fieldPaths: [spec.databaseName]}]

  # ElastiCache
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_metadata_name}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_name}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_engine}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [spec.engine]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_engine_version}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [spec.engineVersion]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_node_type}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [spec.nodeType]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.elasticache_num_cache_nodes}
    targets: [{select: {kind: ElastiCache}, fieldPaths: [spec.numCacheNodes]}]

  # OpenSearch
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_metadata_name}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_name}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_domain_name}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.domainName]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_version}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.version]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_instance_type}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.instanceType]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_instance_count}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.instanceCount]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.opensearch_volume_size}
    targets: [{select: {kind: OpenSearch}, fieldPaths: [spec.volumeSize]}]

  # DataBucket
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_metadata_name}
    targets: [{select: {kind: DataBucket}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_name}
    targets: [{select: {kind: DataBucket}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_bucket_name}
    targets: [{select: {kind: DataBucket}, fieldPaths: [spec.bucketName]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_versioning}
    targets: [{select: {kind: DataBucket}, fieldPaths: [spec.versioning]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_encryption}
    targets: [{select: {kind: DataBucket}, fieldPaths: [spec.encryption]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.data_bucket_public_access}
    targets: [{select: {kind: DataBucket}, fieldPaths: [spec.publicAccess]}]

  # KMS
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.kms_metadata_name}
    targets: [{select: {kind: KMS}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.kms_name}
    targets: [{select: {kind: KMS}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.kms_description}
    targets: [{select: {kind: KMS}, fieldPaths: [spec.description]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.kms_key_rotation}
    targets: [{select: {kind: KMS}, fieldPaths: [spec.keyRotation]}]

  # EFS
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.efs_metadata_name}
    targets: [{select: {kind: EFS}, fieldPaths: [metadata.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.efs_name}
    targets: [{select: {kind: EFS}, fieldPaths: [spec.name]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.efs_performance_mode}
    targets: [{select: {kind: EFS}, fieldPaths: [spec.performanceMode]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.efs_throughput_mode}
    targets: [{select: {kind: EFS}, fieldPaths: [spec.throughputMode]}]
  - source: {kind: ConfigMap, name: spoke-values, fieldPath: data.efs_encrypted}
    targets: [{select: {kind: EFS}, fieldPaths: [spec.encrypted]}]

labels:
  - pairs: {spoke: example-aws-type-1}
    includeSelectors: false
