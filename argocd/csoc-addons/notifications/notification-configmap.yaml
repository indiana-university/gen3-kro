---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd-ns
data:
  # Notification service configuration
  # Uncomment and configure the services you want to use

  # Slack configuration
  # service.slack: |
  #   token: $slack-token

  # Email configuration
  # service.email.smtp: |
  #   host: smtp.gmail.com
  #   port: 465
  #   from: argocd@example.com
  #   username: $email-username
  #   password: $email-password

  # Webhook configuration
  # service.webhook.generic: |
  #   url: https://webhook.site/your-endpoint
  #   headers:
  #     - name: Content-Type
  #       value: application/json

  # Trigger definitions
  trigger.on-sync-failed: |
    - description: Application sync has failed
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']

  trigger.on-sync-succeeded: |
    - description: Application sync has succeeded
      send:
      - app-sync-succeeded
      when: app.status.operationState.phase in ['Succeeded']

  trigger.on-health-degraded: |
    - description: Application health has degraded
      send:
      - app-health-degraded
      when: app.status.health.status in ['Degraded', 'Missing', 'Unknown']

  trigger.on-deployed: |
    - description: Application is synced and healthy
      send:
      - app-deployed
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  trigger.on-sync-running: |
    - description: Application sync is running
      send:
      - app-sync-running
      when: app.status.operationState.phase in ['Running']

  trigger.on-sync-status-unknown: |
    - description: Application sync status is unknown
      send:
      - app-sync-status-unknown
      when: app.status.sync.status == 'Unknown'

  # Notification templates
  template.app-sync-failed: |
    message: |
      ‚ùå **ArgoCD Sync Failed**

      **Application:** {{.app.metadata.name}}
      **Namespace:** {{.app.metadata.namespace}}
      **Cluster:** {{.app.spec.destination.server}}
      **Phase:** {{.app.status.operationState.phase}}
      **Message:** {{.app.status.operationState.message}}

      **Repository:** {{.app.spec.source.repoURL}}
      **Revision:** {{.app.status.sync.revision}}
      **Path:** {{.app.spec.source.path}}

      **Time:** {{.app.status.operationState.finishedAt}}

      [View in ArgoCD]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})
    slack:
      attachments: |
        [{
          "title": "ArgoCD Sync Failed",
          "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
          "color": "danger",
          "fields": [
            {
              "title": "Application",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "Phase",
              "value": "{{.app.status.operationState.phase}}",
              "short": true
            },
            {
              "title": "Repository",
              "value": "{{.app.spec.source.repoURL}}",
              "short": true
            },
            {
              "title": "Revision",
              "value": "{{.app.status.sync.revision}}",
              "short": true
            }
          ]
        }]

  template.app-sync-succeeded: |
    message: |
      ‚úÖ **ArgoCD Sync Succeeded**

      **Application:** {{.app.metadata.name}}
      **Revision:** {{.app.status.sync.revision}}
      **Time:** {{.app.status.operationState.finishedAt}}

  template.app-health-degraded: |
    message: |
      ‚ö†Ô∏è **ArgoCD Application Health Degraded**

      **Application:** {{.app.metadata.name}}
      **Health Status:** {{.app.status.health.status}}
      **Message:** {{.app.status.health.message}}

      [View in ArgoCD]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})
    slack:
      attachments: |
        [{
          "title": "Application Health Degraded",
          "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
          "color": "warning",
          "fields": [
            {
              "title": "Application",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "Health Status",
              "value": "{{.app.status.health.status}}",
              "short": true
            }
          ]
        }]

  template.app-deployed: |
    message: |
      üöÄ **ArgoCD Application Deployed**

      **Application:** {{.app.metadata.name}}
      **Revision:** {{.app.status.sync.revision}}
      **Health:** {{.app.status.health.status}}

  template.app-sync-running: |
    message: |
      ‚è≥ **ArgoCD Sync Running**

      **Application:** {{.app.metadata.name}}
      **Started:** {{.app.status.operationState.startedAt}}

  template.app-sync-status-unknown: |
    message: |
      ‚ùì **ArgoCD Sync Status Unknown**

      **Application:** {{.app.metadata.name}}
      **Sync Status:** {{.app.status.sync.status}}
      **Health Status:** {{.app.status.health.status}}

      [View in ArgoCD]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})

  # Context for templates
  context: |
    argocdUrl: https://argocd.{{.metadata.annotations.domain}}  # Templated from cluster annotation
