apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: aws-eks.kro.run
spec:
  schema:
    apiVersion: v1alpha1
    kind: AwsEKS
    spec:
      name: string
      namespace: string
      region: string | default=""
      environment: string | default="dev"
      project: string | default="kro-managed"
      vpcID: string
      subnetIDs: "[]string"
      version: string | default="1.33"
      nodeGroupInstanceTypes: "[]string | default=[\"t3.medium\"]"
      nodeGroupDesiredSize: integer | default=2
      nodeGroupMinSize: integer | default=1
      nodeGroupMaxSize: integer | default=4
    status:
      clusterARN: ${cluster.status.ackResourceMetadata.arn}
      clusterName: ${cluster.spec.name}
      clusterEndpoint: ${cluster.status.endpoint}
      clusterCertificateAuthority: ${cluster.status.certificateAuthority.data}
      clusterOIDCIssuer: ${cluster.status.identity.oidc.issuer}
      oidcProviderARN: ${oidcProvider.status.ackResourceMetadata.arn}
      nodeGroupARN: ${nodeGroup.status.ackResourceMetadata.arn}
      nodeGroupStatus: ${nodeGroup.status.status}

  resources:
  - id: clusterRole
    template:
      apiVersion: iam.services.k8s.aws/v1alpha1
      kind: Role
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-eks-cluster-role
        annotations:
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: ${schema.spec.name}-eks-cluster-role
        description: "EKS cluster IAM role"
        assumeRolePolicyDocument: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "eks.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
        policies:
          - "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"
        tags:
          - key: "Name"
            value: "${schema.spec.name}-eks-cluster-role"
          - key: "Environment"
            value: "${schema.spec.environment}"
  - id: nodeRole
    template:
      apiVersion: iam.services.k8s.aws/v1alpha1
      kind: Role
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-eks-node-role
        annotations:
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: ${schema.spec.name}-eks-node-role
        description: "EKS node IAM role"
        assumeRolePolicyDocument: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ec2.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
        policies:
          - "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"
          - "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
          - "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
        tags:
          - key: "Name"
            value: "${schema.spec.name}-eks-node-role"
          - key: "Environment"
            value: "${schema.spec.environment}"
  - id: securityGroup
    template:
      apiVersion: ec2.services.k8s.aws/v1alpha1
      kind: SecurityGroup
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-eks-sg
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: ${schema.spec.name}-eks-sg
        description: "EKS cluster security group"
        vpcID: ${schema.spec.vpcID}
        tags:
        - key: Name
          value: ${schema.spec.name}-eks-sg
        - key: Environment
          value: ${schema.spec.environment}
        - key: ManagedBy
          value: Kro
        - key: Project
          value: ${schema.spec.project}
  - id: cluster
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Cluster
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: ${schema.spec.name}-eks
        version: ${schema.spec.version}
        roleARN: ${clusterRole.status.ackResourceMetadata.arn}
        resourcesVPCConfig:
          subnetIDs: ${schema.spec.subnetIDs}
          securityGroupIDs:
            - ${securityGroup.status.id}
          endpointPublicAccess: true
          endpointPrivateAccess: true
        tags:
          Name: ${schema.spec.name}-eks
          Environment: ${schema.spec.environment}
          ManagedBy: Kro
          Project: ${schema.spec.project}

  # OIDC Provider for IRSA (IAM Roles for Service Accounts)
  - id: oidcProvider
    template:
      apiVersion: iam.services.k8s.aws/v1alpha1
      kind: OpenIDConnectProvider
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-oidc
        annotations:
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        url: ${cluster.status.identity.oidc.issuer}
        clientIDs:
          - sts.amazonaws.com
        thumbprints:
          - "9e99a48a9960b14926bb7f3b02e22da2b0ab7280"
        tags:
          - key: "Name"
            value: "${schema.spec.name}-oidc-provider"
          - key: "Environment"
            value: "${schema.spec.environment}"
          - key: "ManagedBy"
            value: "Kro"
          - key: "Cluster"
            value: "${schema.spec.name}-eks"

  - id: nodeGroup
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Nodegroup
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-nodegroup
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: ${schema.spec.name}-eks-nodegroup
        clusterName: ${cluster.spec.name}
        nodeRole: ${nodeRole.status.ackResourceMetadata.arn}
        subnets: ${schema.spec.subnetIDs}
        scalingConfig:
          desiredSize: ${schema.spec.nodeGroupDesiredSize}
          minSize: ${schema.spec.nodeGroupMinSize}
          maxSize: ${schema.spec.nodeGroupMaxSize}
        instanceTypes: ${schema.spec.nodeGroupInstanceTypes}
        tags:
          Name: ${schema.spec.name}-eks-nodegroup
          Environment: ${schema.spec.environment}
          ManagedBy: Kro
          Project: ${schema.spec.project}

  # EKS Addon: VPC-CNI (Amazon VPC networking)
  - id: addonVpcCni
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Addon
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-vpc-cni
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: vpc-cni
        clusterName: ${cluster.spec.name}
        addonVersion: latest
        resolveConflicts: OVERWRITE

  # EKS Addon: kube-proxy
  - id: addonKubeProxy
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Addon
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-kube-proxy
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: kube-proxy
        clusterName: ${cluster.spec.name}
        addonVersion: latest
        resolveConflicts: OVERWRITE

  # EKS Addon: CoreDNS
  - id: addonCoreDns
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Addon
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-coredns
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: coredns
        clusterName: ${cluster.spec.name}
        addonVersion: latest
        resolveConflicts: OVERWRITE

  # EKS Addon: EBS CSI Driver
  - id: addonEbsCsi
    template:
      apiVersion: eks.services.k8s.aws/v1alpha1
      kind: Addon
      metadata:
        namespace: ${schema.spec.namespace}
        name: ${schema.spec.name}-ebs-csi
        annotations:
          services.k8s.aws/region: ${schema.spec.region}
          services.k8s.aws/adoption-policy: "adopt-or-create"
      spec:
        name: aws-ebs-csi-driver
        clusterName: ${cluster.spec.name}
        addonVersion: latest
        resolveConflicts: OVERWRITE
