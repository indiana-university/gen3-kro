apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: aws-generic-commons-and-bucket.kro.run
spec:
  schema:
    apiVersion: v1alpha1
    kind: AwsGenericCommonsAndBucket
    spec:
      name: string
      namespace: string
      region: string | default=""
      environment: string | default="dev"
      project: string | default="kro-managed"
      accountId: string | default=""

      # Feature Toggles - control which resources are deployed
      # Dependencies are listed in order: resource depends on listed features
      # Ordered to match resources block deployment sequence
      features:
        # Layer 1: Foundation (no dependencies)
        enableKMS: boolean | default=true             # 1.1 - standalone
        enableVPC: boolean | default=true             # 1.2 - standalone, VPC is foundational

        # Layer 2: Network Extensions (depends on: 1.2 - VPC core)
        enableSubnet2: boolean | default=true         # 2.1, 2.3 - public/private subnet 2
        enableSubnet3: boolean | default=false        # 2.2, 2.4 - public/private subnet 3
        enableDbSubnet2: boolean | default=true       # 2.6 - depends on: enableSubnet2

        # Layer 3: Audit & Compliance (depends on: enableKMS, enableLoggingBucket, enableCloudWatchLogs)
        enableCloudWatchLogs: boolean | default=false # 3.1 - depends on: enableKMS
        enableLoggingBucket: boolean | default=false  # 3.2 - standalone
        enableCloudTrail: boolean | default=false     # 3.3 - depends on: enableLoggingBucket, enableCloudWatchLogs, enableKMS

        # Layer 4: Compute (depends on: vpcCore, enableSubnet2/3)
        enableEKS: boolean | default=true             # 4.1 - depends on: vpcCore, enableSubnet2/3

        # Layer 5: Data Services - File & Object (standalone or VPC/KMS dependent)
        enableDataBucket: boolean | default=false     # 5.1 - standalone
        enableUploadBucket: boolean | default=false   # 5.2 - standalone
        enableEFS: boolean | default=false            # 5.3 - depends on: vpcCore, enableSubnet2/3, enableKMS
        enableElastiCache: boolean | default=false    # 5.4 - depends on: vpcCore, dbSubnet1, enableDbSubnet2
        enableOpenSearch: boolean | default=false     # 5.5 - depends on: vpcCore, dbSubnet1
        enableAurora: boolean | default=true          # 5.6 - depends on: vpcCore, dbSubnet1, enableDbSubnet2

      # Layer 1: KMS Configuration
      kms:
        description: string | default="Gen3 encryption key"
        enableKeyRotation: boolean | default=true

      # Layer 1-2: VPC Configuration
      vpc:
        vpcCidr: string | default="10.0.0.0/16"
        publicSubnet1Cidr: string | default="10.0.1.0/24"
        publicSubnet2Cidr: string | default="10.0.2.0/24"
        publicSubnet3Cidr: string | default="10.0.3.0/24"
        privateSubnet1Cidr: string | default="10.0.11.0/24"
        privateSubnet2Cidr: string | default="10.0.12.0/24"
        privateSubnet3Cidr: string | default="10.0.13.0/24"
        dbSubnet1Cidr: string | default="10.0.21.0/24"
        dbSubnet2Cidr: string | default="10.0.22.0/24"

      # Layer 3: CloudWatch Logs Configuration
      cloudwatchLogs:
        retentionInDays: integer | default=1827

      # Layer 3: S3 Buckets Configuration
      # Bucket names are auto-generated as: ${name}-${bucket-type}-${accountId}-${region}
      # Example: my-gen3-commons-data-859011005590-us-east-1
      buckets:
        # Logging bucket
        loggingBucket:
          versioning: boolean | default=false
          encryption: boolean | default=true
        # Data bucket
        dataBucket:
          versioning: boolean | default=true
          encryption: boolean | default=true
        # Upload bucket
        uploadBucket:
          versioning: boolean | default=true
          encryption: boolean | default=true

      # Layer 3: CloudTrail Configuration
      cloudtrail:
        enableLogFileValidation: boolean | default=true
        includeGlobalServiceEvents: boolean | default=true
        isMultiRegionTrail: boolean | default=true

      # Layer 4: EKS Configuration
      eks:
        version: string | default="1.33"
        nodeGroupInstanceTypes: "[]string | default=[\"t3.large\"]"
        nodeGroupDesiredSize: integer | default=3
        nodeGroupMinSize: integer | default=2
        nodeGroupMaxSize: integer | default=6

      # Layer 5: EFS Configuration
      efs:
        performanceMode: string | default="generalPurpose"
        throughputMode: string | default="bursting"
        encrypted: boolean | default=true

      # Layer 5: ElastiCache Configuration
      elasticache:
        engine: string | default="redis"
        engineVersion: string | default="7.0"
        nodeType: string | default="cache.t3.micro"
        numCacheNodes: integer | default=1

      # Layer 5: OpenSearch Configuration
      opensearch:
        engineVersion: string | default="OpenSearch_2.11"
        instanceType: string | default="t3.small.search"
        instanceCount: integer | default=1
        volumeSize: integer | default=10

      # Layer 5: Aurora PostgreSQL Configuration
      aurora:
        engine: string | default="aurora-postgresql"
        engineVersion: string | default="15.4"
        instanceClass: string | default="db.r5.large"
        instanceCount: integer | default=2
        databaseName: string | default="gen3"
        masterUsername: string | default="admin"
        backupRetentionPeriod: integer | default=7

    status:
      # Layer 1: Foundation
      kmsKeyID: ${kms.?status.?keyID}
      kmsKeyARN: ${kms.?status.?keyARN}
      vpcID: ${vpcCore.status.vpcID}
      vpcPublicSubnet1ID: ${vpcCore.status.publicSubnetID}
      vpcPrivateSubnet1ID: ${vpcCore.status.privateSubnetID}
      # Layer 2: Network Extensions
      vpcPublicSubnet2ID: ${publicSubnet2.?status.?subnetID}
      vpcPublicSubnet3ID: ${publicSubnet3.?status.?subnetID}
      vpcPrivateSubnet2ID: ${privateSubnet2.?status.?subnetID}
      vpcPrivateSubnet3ID: ${privateSubnet3.?status.?subnetID}
      vpcDbSubnet1ID: ${dbSubnet1.?status.?subnetID}
      vpcDbSubnet2ID: ${dbSubnet2.?status.?subnetID}
      # Layer 3: Audit & Compliance
      cloudwatchLogsGroupARN: ${cloudwatchLogs.?status.?logGroupARN}
      loggingBucketName: ${loggingBucket.?status.?s3Name}
      loggingBucketArn: ${loggingBucket.?status.?s3ARN}
      cloudtrailARN: ${cloudtrail.?status.?trailARN}
      # Layer 4: Compute - EKS Cluster
      # NOTE: These fields use default empty strings so they're always defined in the schema
      # This allows dependent RGDs (like gen3-application) to reference them without optional chaining
      eksClusterName: "${ has(eks.status.clusterName) ? eks.status.clusterName : '' }"
      eksClusterEndpoint: "${ has(eks.status.clusterEndpoint) ? eks.status.clusterEndpoint : '' }"
      eksClusterARN: "${ has(eks.status.clusterARN) ? eks.status.clusterARN : '' }"
      eksClusterCertificateAuthority: "${ has(eks.status.clusterCertificateAuthority) ? eks.status.clusterCertificateAuthority : '' }"
      eksClusterOIDCIssuer: "${ has(eks.status.clusterOIDCIssuer) ? eks.status.clusterOIDCIssuer : '' }"
      eksOIDCProviderARN: "${ has(eks.status.oidcProviderARN) ? eks.status.oidcProviderARN : '' }"
      # Layer 5: Data Services
      # NOTE: Using defaults for fields that may be referenced by dependent RGDs
      auroraClusterEndpoint: "${ has(aurora.status.clusterEndpoint) ? aurora.status.clusterEndpoint : '' }"
      auroraReaderEndpoint: "${ has(aurora.status.readerEndpoint) ? aurora.status.readerEndpoint : '' }"
      auroraMasterPasswordSecretARN: "${ has(aurora.status.masterPasswordSecretARN) ? aurora.status.masterPasswordSecretARN : '' }"
      elasticacheEndpoint: "${ has(elasticache.status.endpoint) ? elasticache.status.endpoint : '' }"
      dataBucketName: "${ has(dataBucket.status.s3Name) ? dataBucket.status.s3Name : '' }"
      dataBucketArn: "${ has(dataBucket.status.s3ARN) ? dataBucket.status.s3ARN : '' }"
      efsFileSystemID: "${ has(efs.status.fileSystemID) ? efs.status.fileSystemID : '' }"
      uploadBucketName: "${ has(uploadBucket.status.s3Name) ? uploadBucket.status.s3Name : '' }"
      uploadBucketArn: "${ has(dataBucket.status.s3ARN) ? dataBucket.status.s3ARN : '' }"
      opensearchDomainARN: "${ has(opensearch.status.domainARN) ? opensearch.status.domainARN : '' }"
      opensearchDomainEndpoint: "${ has(opensearch.status.endpoint) ? opensearch.status.endpoint : '' }"

  resources:
  # LAYER 1: Foundational Network and Encryption

  # 1.1 KMS encryption key
  # Contains: KMS key for encryption
  - id: kms
    includeWhen:
      - ${schema.spec.features.enableKMS}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsKMS
      metadata:
        name: ${schema.spec.name}-kms
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        accountId: ${schema.spec.accountId}
        environment: ${schema.spec.environment}
        description: ${schema.spec.kms.description}
        enableKeyRotation: ${schema.spec.kms.enableKeyRotation}

  # 1.2 VPC core infrastructure
  # Contains: VPC, IGW, first public/private subnets, NAT
  - id: vpcCore
    includeWhen:
      - ${schema.spec.features.enableVPC}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpc
      metadata:
        name: ${schema.spec.name}-vpc
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        cidr:
          vpcCidr: ${schema.spec.vpc.vpcCidr}
          publicSubnetCidr: ${schema.spec.vpc.publicSubnet1Cidr}
          privateSubnetCidr: ${schema.spec.vpc.privateSubnet1Cidr}

  # LAYER 2: Network Extensions

  # 2.1 Public subnet 2 (depends on: 1.2 - VPC core)
  # Contains: Public subnet in AZ-b
  - id: publicSubnet2
    includeWhen:
      - ${schema.spec.features.enableSubnet2}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcPublicSubnet
      metadata:
        name: ${schema.spec.name}-public-subnet-2
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-2
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}b
        cidrBlock: ${schema.spec.vpc.publicSubnet2Cidr}
        vpcID: ${vpcCore.status.vpcID}
        internetGatewayID: ${vpcCore.status.internetGatewayID}

  # 2.2 Public subnet 3 (depends on: 1.2 - VPC core)
  # Contains: Public subnet in AZ-c
  - id: publicSubnet3
    includeWhen:
      - ${schema.spec.features.enableSubnet3}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcPublicSubnet
      metadata:
        name: ${schema.spec.name}-public-subnet-3
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-3
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}c
        cidrBlock: ${schema.spec.vpc.publicSubnet3Cidr}
        vpcID: ${vpcCore.status.vpcID}
        internetGatewayID: ${vpcCore.status.internetGatewayID}

  # 2.3 Private subnet 2 (depends on: 1.2 - VPC core, 2.1 - Public subnet 2)
  # Contains: Private subnet in AZ-b with NAT
  - id: privateSubnet2
    includeWhen:
      - ${schema.spec.features.enableSubnet2}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcPrivateSubnet
      metadata:
        name: ${schema.spec.name}-private-subnet-2
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-2
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}b
        cidrBlock: ${schema.spec.vpc.privateSubnet2Cidr}
        vpcID: ${vpcCore.status.vpcID}
        publicSubnetID: ${publicSubnet2.status.subnetID}

  # 2.4 Private subnet 3 (depends on: 1.2 - VPC core, 2.2 - Public subnet 3)
  # Contains: Private subnet in AZ-c with NAT
  - id: privateSubnet3
    includeWhen:
      - ${schema.spec.features.enableSubnet3}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcPrivateSubnet
      metadata:
        name: ${schema.spec.name}-private-subnet-3
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-3
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}c
        cidrBlock: ${schema.spec.vpc.privateSubnet3Cidr}
        vpcID: ${vpcCore.status.vpcID}
        publicSubnetID: ${publicSubnet3.status.subnetID}

  # 2.5 Database subnet 1 (depends on: 1.2 - VPC core)
  # Contains: Database subnet in AZ-a
  - id: dbSubnet1
    includeWhen:
      - ${ schema.spec.features.enableAurora || schema.spec.features.enableElastiCache || schema.spec.features.enableOpenSearch }
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcDbSubnet
      metadata:
        name: ${schema.spec.name}-db-subnet-1
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-1
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}a
        cidrBlock: ${schema.spec.vpc.dbSubnet1Cidr}
        vpcID: ${vpcCore.status.vpcID}
        privateRouteTableID: ${vpcCore.status.privateRouteTableID}

  # 2.6 Database subnet 2 (depends on: 1.2 - VPC core, 2.3 - Private subnet 2)
  # Contains: Database subnet in AZ-b
  - id: dbSubnet2
    includeWhen:
      - ${schema.spec.features.enableDbSubnet2}
      - ${ schema.spec.features.enableAurora || schema.spec.features.enableElastiCache || schema.spec.features.enableOpenSearch }
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsVpcDbSubnet
      metadata:
        name: ${schema.spec.name}-db-subnet-2
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}-2
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        availabilityZone: ${schema.spec.region}b
        cidrBlock: ${schema.spec.vpc.dbSubnet2Cidr}
        vpcID: ${vpcCore.status.vpcID}
        privateRouteTableID: "${ schema.spec.features.enableSubnet2 ? privateSubnet2.status.privateRouteTableID : vpcCore.status.privateRouteTableID }"

  # LAYER 3: Audit & Compliance

  # 3.1 CloudWatch Logs (depends on: 1.1 - KMS encryption key)
  # Contains: CloudWatch log group
  - id: cloudwatchLogs
    includeWhen:
      - ${schema.spec.features.enableCloudWatchLogs}
      - ${schema.spec.features.enableKMS}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsCloudWatchLogs
      metadata:
        name: ${schema.spec.name}-logs
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        logGroupName: /aws/${schema.spec.name}
        retentionInDays: ${schema.spec.cloudwatchLogs.retentionInDays}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # 3.2 Logging S3 bucket
  # Contains: S3 bucket for logs
  # Name pattern: ${name}-logging-bucket
  - id: loggingBucket
    includeWhen:
      - ${schema.spec.features.enableLoggingBucket}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsS3Bucket
      metadata:
        name: "${schema.spec.name}-logging-bucket"
        namespace: ${schema.spec.namespace}
      spec:
        name: "${schema.spec.name}-logging-bucket"
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        versioning: ${schema.spec.buckets.loggingBucket.versioning}
        encryption: ${schema.spec.buckets.loggingBucket.encryption}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # 3.3 CloudTrail (depends on: 1.1 - KMS encryption key, 3.1 - CloudWatch Logs, 3.2 - Logging S3 bucket)
  # Contains: CloudTrail audit logging
  - id: cloudtrail
    includeWhen:
      - ${schema.spec.features.enableCloudTrail}
      - ${schema.spec.features.enableLoggingBucket}
      - ${schema.spec.features.enableCloudWatchLogs}
      - ${schema.spec.features.enableKMS}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsCloudTrail
      metadata:
        name: ${schema.spec.name}-trail
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        accountId: ${schema.spec.accountId}
        s3BucketName: ${loggingBucket.status.s3Name}
        cloudWatchLogsLogGroupARN: ${cloudwatchLogs.status.logGroupARN}
        enableLogFileValidation: ${schema.spec.cloudtrail.enableLogFileValidation}
        includeGlobalServiceEvents: ${schema.spec.cloudtrail.includeGlobalServiceEvents}
        isMultiRegionTrail: ${schema.spec.cloudtrail.isMultiRegionTrail}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # LAYER 4: Compute

  # 4.1 EKS cluster (depends on: 1.2 - VPC core, 2.3 - Private subnet 2, 2.4 - Private subnet 3)
  # Contains: EKS cluster, node group, security group, IAM roles
  - id: eks
    includeWhen:
      - ${schema.spec.features.enableEKS}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsEKS
      metadata:
        name: ${schema.spec.name}-eks
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        vpcID: ${vpcCore.status.vpcID}
        subnetIDs: "${ [vpcCore.status.privateSubnetID] + (schema.spec.features.enableSubnet2 ? [privateSubnet2.status.subnetID] : []) + (schema.spec.features.enableSubnet3 ? [privateSubnet3.status.subnetID] : []) }"
        version: ${schema.spec.eks.version}
        nodeGroupInstanceTypes: ${schema.spec.eks.nodeGroupInstanceTypes}
        nodeGroupDesiredSize: ${schema.spec.eks.nodeGroupDesiredSize}
        nodeGroupMinSize: ${schema.spec.eks.nodeGroupMinSize}
        nodeGroupMaxSize: ${schema.spec.eks.nodeGroupMaxSize}

  # LAYER 5: Data Services

  # 5.1 Data S3 bucket
  # Contains: S3 bucket for data storage
  # Name pattern: ${name}-data-bucket
  - id: dataBucket
    includeWhen:
      - ${schema.spec.features.enableDataBucket}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsS3Bucket
      metadata:
        name: "${schema.spec.name}-data-bucket"
        namespace: ${schema.spec.namespace}
      spec:
        name: "${schema.spec.name}-data-bucket"
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        versioning: ${schema.spec.buckets.dataBucket.versioning}
        encryption: ${schema.spec.buckets.dataBucket.encryption}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # 5.2 Upload S3 bucket
  # Contains: S3 bucket for uploads
  # Name pattern: ${name}-upload-bucket
  - id: uploadBucket
    includeWhen:
      - ${schema.spec.features.enableUploadBucket}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsS3Bucket
      metadata:
        name: "${schema.spec.name}-upload-bucket"
        namespace: ${schema.spec.namespace}
      spec:
        name: "${schema.spec.name}-upload-bucket"
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        versioning: ${schema.spec.buckets.uploadBucket.versioning}
        encryption: ${schema.spec.buckets.uploadBucket.encryption}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # 5.3 EFS file system (depends on: 1.1 - KMS encryption key, 1.2 - VPC core, 2.3 - Private subnet 2, 2.4 - Private subnet 3)
  # Contains: EFS file system, mount targets, security group
  - id: efs
    includeWhen:
      - ${schema.spec.features.enableEFS}
      - ${schema.spec.features.enableKMS}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsEFS
      metadata:
        name: ${schema.spec.name}-efs
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        vpcID: ${vpcCore.status.vpcID}
        subnetIDs: "${ [vpcCore.status.privateSubnetID] + (schema.spec.features.enableSubnet2 ? [privateSubnet2.status.subnetID] : []) + (schema.spec.features.enableSubnet3 ? [privateSubnet3.status.subnetID] : []) }"
        ingressIPRanges: "${ [schema.spec.vpc.privateSubnet1Cidr] + (schema.spec.features.enableSubnet2 ? [schema.spec.vpc.privateSubnet2Cidr] : []) + (schema.spec.features.enableSubnet3 ? [schema.spec.vpc.privateSubnet3Cidr] : []) }"
        performanceMode: ${schema.spec.efs.performanceMode}
        throughputMode: ${schema.spec.efs.throughputMode}
        encrypted: ${schema.spec.efs.encrypted}
        kmsKeyARN: "${ schema.spec.features.enableKMS ? kms.status.keyARN : \"\" }"

  # 5.4 ElastiCache Redis (depends on: 1.2 - VPC core, 2.5 - Database subnet 1, 2.6 - Database subnet 2)
  # Contains: ElastiCache cluster, subnet group, security group
  - id: elasticache
    includeWhen:
      - ${schema.spec.features.enableElastiCache}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsElastiCache
      metadata:
        name: ${schema.spec.name}-elasticache
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        vpcID: ${vpcCore.status.vpcID}
        subnetIDs: "${ [dbSubnet1.status.subnetID] + (schema.spec.features.enableDbSubnet2 ? [dbSubnet2.status.subnetID] : []) }"
        ingressIPRanges: "${ [schema.spec.vpc.privateSubnet1Cidr] + (schema.spec.features.enableSubnet2 ? [schema.spec.vpc.privateSubnet2Cidr] : []) + (schema.spec.features.enableSubnet3 ? [schema.spec.vpc.privateSubnet3Cidr] : []) }"
        engine: ${schema.spec.elasticache.engine}
        engineVersion: ${schema.spec.elasticache.engineVersion}
        nodeType: ${schema.spec.elasticache.nodeType}
        numCacheNodes: ${schema.spec.elasticache.numCacheNodes}

  # 5.5 OpenSearch domain (depends on: 1.2 - VPC core, 2.5 - Database subnet 1)
  # Contains: OpenSearch domain, security group
  - id: opensearch
    includeWhen:
      - ${schema.spec.features.enableOpenSearch}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsOpenSearch
      metadata:
        name: ${schema.spec.name}-opensearch
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        vpcID: ${vpcCore.status.vpcID}
        subnetIDs: "${ [dbSubnet1.status.subnetID] }"
        ingressIPRanges: "${ [schema.spec.vpc.privateSubnet1Cidr] + (schema.spec.features.enableSubnet2 ? [schema.spec.vpc.privateSubnet2Cidr] : []) + (schema.spec.features.enableSubnet3 ? [schema.spec.vpc.privateSubnet3Cidr] : []) }"
        engineVersion: ${schema.spec.opensearch.engineVersion}
        instanceType: ${schema.spec.opensearch.instanceType}
        instanceCount: ${schema.spec.opensearch.instanceCount}
        volumeSize: ${schema.spec.opensearch.volumeSize}

  # 5.6 Aurora PostgreSQL (depends on: 1.2 - VPC core, 2.5 - Database subnet 1, 2.6 - Database subnet 2)
  # Contains: Aurora cluster, instances, subnet group, security group
  - id: aurora
    includeWhen:
      - ${schema.spec.features.enableAurora}
    template:
      apiVersion: kro.run/v1alpha1
      kind: AwsAurora
      metadata:
        name: ${schema.spec.name}-aurora
        namespace: ${schema.spec.namespace}
      spec:
        name: ${schema.spec.name}
        namespace: ${schema.spec.namespace}
        region: ${schema.spec.region}
        environment: ${schema.spec.environment}
        vpcID: ${vpcCore.status.vpcID}
        subnetIDs: "${ [dbSubnet1.status.subnetID] + (schema.spec.features.enableDbSubnet2 ? [dbSubnet2.status.subnetID] : []) }"
        ingressIPRanges: "${ [schema.spec.vpc.privateSubnet1Cidr] + (schema.spec.features.enableSubnet2 ? [schema.spec.vpc.privateSubnet2Cidr] : []) + (schema.spec.features.enableSubnet3 ? [schema.spec.vpc.privateSubnet3Cidr] : []) }"
        engine: ${schema.spec.aurora.engine}
        engineVersion: ${schema.spec.aurora.engineVersion}
        instanceClass: ${schema.spec.aurora.instanceClass}
        instanceCount: ${schema.spec.aurora.instanceCount}
        databaseName: ${schema.spec.aurora.databaseName}
        masterUsername: ${schema.spec.aurora.masterUsername}
        backupRetentionPeriod: ${schema.spec.aurora.backupRetentionPeriod}
