# Terraform Catalog

Hierarchical Terraform infrastructure catalog supporting multi-cloud Gen3 deployments across AWS, Azure, and Google Cloud.

## Architecture

The catalog uses a three-tier layering approach to promote reusability and minimize duplication:

```
terraform/catalog/
├── modules/         # Tier 1: Cloud-agnostic and provider-specific primitives
├── combinations/    # Tier 2: Composed infrastructure patterns (hub/csoc, spoke)
└── (units)          # Tier 3: Terragrunt unit wrappers (located in terraform/units/)
```

**Tier 1 - Modules** (`modules/`): Single-purpose building blocks (VPC, Kubernetes cluster, IAM role). Each module abstracts provider differences and exposes a consistent interface.

**Tier 2 - Combinations** (`combinations/`): Multi-module compositions representing complete infrastructure patterns (e.g., `csoc/aws` combines `aws-vpc`, `aws-eks-cluster`, `aws-pod-identity`, `argocd`). Organized by role (csoc, spoke) and provider (aws, azure, gcp).

**Tier 3 - Units** (`../units/`): Terragrunt wrappers that stitch combinations into deployable units with provider configuration, backend generation, and input mapping. See [`terraform/units/README.md`](../units/README.md).

## Supported Providers

| Provider | Region Model | Cluster Type | IAM Mechanism | Combination Paths |
|----------|--------------|--------------|---------------|-------------------|
| AWS | Regional (`us-east-1`, `us-west-2`) | EKS | Pod Identity | `combinations/csoc/aws`, `combinations/spoke/aws` |
| Azure | Location (`eastus`, `westus2`) | AKS | Managed Identity | `combinations/csoc/azure`, `combinations/spoke/azure` |
| GCP | Regional/Zonal (`us-central1`) | GKE | Workload Identity | `combinations/csoc/gcp`, `combinations/spoke/gcp` |

## Tooling Versions

Minimum required versions:

- **Terraform**: `>= 1.5.0`
- **Terragrunt**: `>= 0.66.0`

For complete tool inventory and versions installed in the development environment, see [`.devcontainer/README.md`](../.devcontainer/README.md).

Provider version constraints are defined in each module's `versions.tf`.

## Testing Workflow

For comprehensive testing standards and validation procedures, see [`docs/guides/contributing.md`](../../docs/guides/contributing.md#testing-requirements).

**Quick validation:**

```bash
cd terraform/catalog/modules/<module-name>
terraform init && terraform validate && terraform fmt -check
```

**Integration testing** occurs in `live/` environments. See [`live/README.md`](../../live/README.md) for deployment procedures.

## Customization

Override module defaults by adjusting variables in combination `variables.tf` or unit `terragrunt.hcl` files. For environment-specific overrides, modify `live/<env>/terragrunt.stack.hcl`.

See [`docs/guides/customization.md`](../../docs/guides/customization.md) for detailed customization workflows, including:
- Adding new modules
- Extending combinations with additional resources
- Injecting custom IAM policies from `iam/`

## Lifecycle Notes

- **State management**: Backends are auto-generated by Terragrunt units (S3 for AWS, Azure Storage for Azure, GCS for GCP)
- **Dependency ordering**: Combinations use explicit `depends_on` to sequence module creation (e.g., VPC → EKS → ArgoCD)
- **Tagging strategy**: All resources inherit base tags from `terragrunt.stack.hcl` (`Terraform`, `Environment`, `caller`, `module`)
- **Drift detection**: Run `terragrunt plan --all` periodically to detect configuration drift

---
**Last updated:** 2025-10-28
